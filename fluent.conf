<source>
  @type forward
  port 24224
  bind 0.0.0.0
  # Increase buffer size to capture large stack traces
  chunk_size_limit 10m
</source>

<label @FLUENT_LOG>
  <match fluent.**>
    @type file
    path /fluentd/log/fluentd
    append true
    <format>
      @type json
    </format>
    <buffer>
      flush_mode interval
      flush_interval 1s
    </buffer>
  </match>
</label>

# Concatenate multi-line logs (like Python stack traces)
<filter **>
  @type concat
  key log
  multiline_start_regexp /^(Traceback|ERROR|WARNING|INFO|DEBUG|CRITICAL|\d{4}-\d{2}-\d{2})/
  flush_interval 2s
  use_first_timestamp true
</filter>

<match **>
  @type file
  path /fluentd/log/docker
  append true
  <format>
    @type json
  </format>
  <buffer>
    flush_mode interval
    flush_interval 1s
    chunk_limit_size 10m
  </buffer>
</match>
